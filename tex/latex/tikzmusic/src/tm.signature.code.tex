%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% KEY SIGNATURES

\def\tm@sharplist{4,1,5,2,-1,3,0}
\def\tm@flatlist{0,3,-1,2,-2,1,-3}
\newcommand\tm@outputsharp[4][]{
  \begingroup\tmset{#1}
    \foreach \tm@i [count=\tm@j] in \tm@sharplist {
      \path[xshift=#2cm,yshift=\tm@lineshift*0.2cm/2] pic[color/.expanded=\tm@color] at (\tm@j*.18,\tm@i*.1) {tm-#4};
      \ifnum\tm@j=#3\breakforeach\fi
    }
  \endgroup
}
\newcommand\tm@outputflat[4][0]{
  \begingroup\tmset{#1}
    \foreach \tm@i [count=\tm@j] in \tm@flatlist {
      \path[xshift=#2cm,yshift=\tm@lineshift*0.2cm/2] pic[color/.expanded=\tm@color] at (\tm@j*.18,\tm@i*.1) {tm-#4};
      \ifnum\tm@j=#3\breakforeach\fi
    }
  \endgroup
}
\newcommand\tmkeysignature[4][]{
  \ifstrequal{#3}{sharp}{\tm@outputsharp[#1]{#2}{#4}{sharp}}{}
  \ifstrequal{#3}{flat}{\tm@outputflat[#1]{#2}{#4}{flat}}{}
  \ifstrequal{#3}{nsharp}{\tm@outputsharp[#1]{#2}{#4}{natural}}{}
  \ifstrequal{#3}{nflat}{\tm@outputflat[#1]{#2}{#4}{natural}}{}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TIME SIGNATURES

\newcommand\tmtimesignature[4][]{
  \begingroup
    \tmset{#1}
    \coordinate (x) at (#2,0);
    \path (x) node[above,inner sep=0pt] {\tm@@@timesignature{#3}};
    \path (x) node[below,inner sep=0pt] {\tm@@@timesignature{#4}};
  \endgroup
}
\newcommand\tmtimesignaturecommon[2][]{
  \begingroup
    \tmset{#1}
    \pic[color/.expanded=\tm@color] at (#2,0) {tm-common-time};
  \endgroup
}
\newcommand\tmtimesignatureallabreve[2][]{
  \begingroup
    \tmset{#1}
    \pic[color/.expanded=\tm@color] at (#2,0) {tm-alla-breve-time};
  \endgroup
}
\def\tm@@@timesignature#1{%
  \pgfmathtruncatemacro\tm@timesignature@fi{div(#1,10)}%
  \pgfmathtruncatemacro\tm@timesignature@se{mod(#1,10)}%
  \ifnum\tm@timesignature@fi=0\else%
  % Hmm, nesting tikzpictures...
  \tikz{\pic[color/.expanded=\tm@color]{tm-number-\tm@timesignature@fi};}\fi%
  \tikz{\pic[color/.expanded=\tm@color]{tm-number-\tm@timesignature@se};}%
}