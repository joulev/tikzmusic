\pgfkeys{/tm/.is family}
\def\tmset{\pgfqkeys{/tm}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PREDEFINED KEYS
\tmset{
  % Color
  color/.store in=\tm@color,
  color/.initial=black,
  color/.get=\tm@color,
  color/.value required,
  % Line color
  line color/.store in=\tm@linecolor,
  line color/.initial=black,
  line color/.get=\tm@linecolor,
  line color/.value required,
  % Stem length
  note length/.store in=\tm@notelength,
  note length/.initial=6mm,
  note length/.get=\tm@notelength,
  note length/.value required,
  % Shifting
  start xshift/.store in=\tm@shift@start@x,
  start xshift/.initial=0pt,
  start xshift/.get=\tm@shift@start@x,
  start xshift/.value required,
  %
  start yshift/.store in=\tm@shift@start@y,
  start yshift/.initial=0pt,
  start yshift/.get=\tm@shift@start@y,
  start yshift/.value required,
  %
  end xshift/.store in=\tm@shift@end@x,
  end xshift/.initial=0pt,
  end xshift/.get=\tm@shift@end@x,
  end xshift/.value required,
  %
  end yshift/.store in=\tm@shift@end@y,
  end yshift/.initial=0pt,
  end yshift/.get=\tm@shift@end@y,
  end yshift/.value required,
  %
  xshift/.style={start xshift=#1,end xshift=#1},
  xshift/.value required,
  yshift/.style={start yshift=#1,end yshift=#1},
  yshift/.value required,
  %
  start shift/.code={
    \path[overlay] #1; \pgfgetlastxy{\tm@x}{\tm@y}
    \pgfkeysalso{start xshift/.expanded=\tm@x,start yshift/.expanded=\tm@y}
  },
  start shift/.value required,
  end shift/.code={
    \path[overlay] #1; \pgfgetlastxy{\tm@x}{\tm@y}
    \pgfkeysalso{end xshift/.expanded=\tm@x,end yshift/.expanded=\tm@y}
  },
  end shift/.value required,
  %
  shift/.code={
    \path[overlay] #1; \pgfgetlastxy{\tm@x}{\tm@y}
    \pgfkeysalso{xshift/.expanded=\tm@x,yshift/.expanded=\tm@y}
  },
  shift/.value required,
  %
  line shift/.store in=\tm@lineshift,
  line shift/.initial=0,
  line shift/.get=\tm@lineshift,
  line shift/.value required,
  % STAFF
  staff offset/.store in=\tm@staff@offset,
  staff offset/.initial=0pt,
  staff offset/.get=\tm@staff@offset,
  staff offset/.value required,
  %
  brace middle xshift/.store in=\tm@staff@mid@shift@x,
  brace middle xshift/.initial=0pt,
  brace middle xshift/.get=\tm@staff@mid@shift@x,
  brace middle xshift/.value required,
  %
  brace middle yshift/.store in=\tm@staff@mid@shift@y,
  brace middle yshift/.initial=0pt,
  brace middle yshift/.get=\tm@staff@mid@shift@y,
  brace middle yshift/.value required,
  %
  brace middle shift/.code={
    \path[overlay] #1; \pgfgetlastxy{\tm@x}{\tm@y}
    \pgfkeysalso{brace middle xshift/.expanded=\tm@x,brace middle yshift/.expanded=\tm@y}
  },
  % NOTES
  relative/.store in=\tm@note@relativepos,
  relative/.initial=center,
  relative/.get=\tm@note@relativepos,
  relative/.value required,
  %
  use note color/.is if=tm@usenotecolor,
  use note color/.default=true,
  % LINES
  amplitude/.store in=\tm@amplitude,
  amplitude/.initial=2.5mm,
  amplitude/.get=\tm@amplitude,
  amplitude/.value required,
  %
  cresc dim sep/.store in=\tm@crescdimsep,
  cresc dim sep/.initial=3mm,
  cresc dim sep/.get=\tm@crescdimsep,
  cresc dim sep/.value required,
}


%%%%%%%%%%%%%%%%%%%%%%%
% SPECIAL ACTIONS
\tmset{
  % Detect color if key is unknown
  .unknown/.code={
    \edef\tm@unknown@key{\pgfkeyscurrentname}
    \pgfkeysalso{color/.expand once=\tm@unknown@key,line color/.expand once=\tm@unknown@key}
  },
}