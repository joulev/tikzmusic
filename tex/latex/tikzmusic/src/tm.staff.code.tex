\newlength\tm@multiplelineswidth

\def\tm@createstaff{%
  \foreach \tm@i in {-2,-1,0,1,2}
    \draw[line cap=rect,color/.expanded=\tmcolor] (0,\tm@i*0.2) -- ++ (\linewidth-\pgflinewidth,0);
  \draw[color/.expanded=\tmcolor] (0,-2*0.2) -- ++ (0,4*0.2);
}

\newenvironment{tmsinglestaff}{%
  \par\setlength\parindent{0pt}%
  \begin{minipage}{\linewidth}%
}{\end{minipage}\par}

\newenvironment{tmmultiplestaves}[1][2cm]{%
  \par\setlength\parindent{0pt}%
  \setlength\tm@multiplelineswidth{\dimexpr(\linewidth-#1)\relax}%
  \hfill%
  \begin{minipage}{\tm@multiplelineswidth}%
}{\end{minipage}\par}

\NewDocumentEnvironment{tmstaff}{ m O{@auxiliary} }{%
  \par\begin{tikzpicture}[remember picture]
    \tm@createstaff
    \pic[color/.expanded=\tmcolor] at (0.2,0) {tm-#1-clef};
    \coordinate (#2-nw) at (0,2*0.2);
    \coordinate (#2-sw) at (0,-2*0.2);
    \coordinate (#2-start) at (0,0);
    \ifstrequal{#1}{g}{\pgfmathsetmacro\tm@note@mid@clef{30}}{}
    \ifstrequal{#1}{c}{\pgfmathsetmacro\tm@note@mid@clef{24}}{}
    \ifstrequal{#1}{f}{\pgfmathsetmacro\tm@note@mid@clef{18}}{}
}{\end{tikzpicture}}

\newenvironment{tmstaff*}[1][@auxiliary]{%
  \par\begin{tikzpicture}[remember picture]
    \tm@createstaff
    \coordinate (#1-nw) at (0,2*0.2);
    \coordinate (#1-sw) at (0,-2*0.2);
    \coordinate (#1-start) at (0,0);
    \pgfmathsetmacro\tm@note@mid@clef{30}
}{\end{tikzpicture}}

\def\tmbrace#1#2#3{%
  \begin{tikzpicture}[remember picture,overlay]
    \coordinate (x) at ([xshift=-2mm]#1-nw);
    \coordinate (y) at ([xshift=-2mm]#2-sw);
    \coordinate (c) at ([xshift=-2mm]$(x)!.5!(y)$);
    \pen (135:.35mm) -- (-45:.35mm);
    \calligraphy[pen colour/.expanded=\tmcolor] 
      (y) .. controls ([xshift=-3.5mm]$(y)!.25!(c)$) and ([xshift=3.5mm]$(y)!.75!(c)$) .. (c);
    \draw[color/.expanded=\tmcolor] 
      (y) .. controls ([xshift=-3.5mm]$(y)!.25!(c)$) and ([xshift=3.5mm]$(y)!.75!(c)$) .. (c);
    \pen (-135:.35mm) -- (45:.35mm);
    \calligraphy[pen colour/.expanded=\tmcolor] 
      (x) .. controls ([xshift=-3.5mm]$(x)!.25!(c)$) and ([xshift=3.5mm]$(x)!.75!(c)$) .. (c);
    \draw[color/.expanded=\tmcolor] 
      (x) .. controls ([xshift=-3.5mm]$(x)!.25!(c)$) and ([xshift=3.5mm]$(x)!.75!(c)$) .. (c);
    \path (c) node[left,color/.expanded=\tmcolor] {#3};
  \end{tikzpicture}%
}

\def\tmbracket#1#2{%
  \begin{tikzpicture}[remember picture,overlay]
    \coordinate (x) at ([xshift=-1mm,yshift=1mm]#1-nw);
    \coordinate (y) at ([xshift=-1mm,yshift=-1mm]#2-sw);
    \draw[line width=.5mm,color/.expanded=\tmcolor] ([yshift=.5mm]x) -- ([yshift=-.5mm]y);
    \draw[fill,color/.expanded=\tmcolor] 
      (x) cos ++ (.25,.2) sin ([yshift=.5mm]x) (y) cos ++ (.25,-.2) sin ([yshift=-.5mm]y);
  \end{tikzpicture}%
}